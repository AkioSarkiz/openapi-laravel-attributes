"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createDev = void 0;
const utils_1 = require("@vuepress/utils");
const webpack = require("webpack");
const WebpackDevServer = require("webpack-dev-server");
const utils_2 = require("../utils");
const createDevConfig_1 = require("./createDevConfig");
const createDevServerConfig_1 = require("./createDevServerConfig");
/**
 * Create the dev method of webpack bundler
 */
const createDev = (options) => async (app) => {
    // create webpack config
    const config = await createDevConfig_1.createDevConfig(app, options);
    const webpackConfig = utils_2.resolveWebpackConfig({
        config,
        options,
        isServer: false,
        isBuild: false,
    });
    // create webpack compiler
    const compiler = webpack(webpackConfig);
    // create webpack-dev-server
    const serverConfig = await createDevServerConfig_1.createDevServerConfig(app, options);
    const server = new WebpackDevServer(serverConfig, compiler);
    const [, close] = await Promise.all([
        // wait for webpack-dev-server to start
        server.start(),
        // wait for webpack compilation to complete
        new Promise((resolve, reject) => {
            // create spinner
            const spinner = utils_1.ora();
            let hasStarted = false;
            let hasFinished = false;
            // start spinner before the first compilation
            compiler.hooks.beforeCompile.tap('vuepress-dev', () => {
                if (hasStarted)
                    return;
                hasStarted = true;
                spinner.start('Compiling with webpack...');
            });
            // stop spinner, show compilation time and print url after first compilation
            compiler.hooks.done.tap('vuepress-dev', ({ endTime, startTime }) => {
                if (hasFinished)
                    return;
                hasFinished = true;
                spinner.succeed(`Compilation finished in ${endTime - startTime}ms`);
                // replace `0.0.0.0` with `localhost` as `0.0.0.0` is not available on windows
                const url = `http://${serverConfig.host === '0.0.0.0' ? 'localhost' : serverConfig.host}:${serverConfig.port}${app.options.base}`;
                utils_1.logger.success(`VuePress webpack dev server is listening at ${utils_1.chalk.cyan(url)}`);
                // resolve the close function
                resolve(() => server.stop());
            });
            // stop spinner and reject error if the first compilation is failed
            compiler.hooks.failed.tap('vuepress-dev', (err) => {
                if (hasFinished)
                    return;
                hasFinished = true;
                spinner.fail('Compilation failed');
                reject(err);
            });
        }),
    ]);
    // return the close function
    return close;
};
exports.createDev = createDev;
